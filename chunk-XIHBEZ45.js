import{a as Z,b as Te}from"./chunk-D2AGE2H7.js";import{Ba as Ee,Fa as Fe,Ga as U,Ha as Ne,K as Se,L as M,Z as ye,_ as w,d as W,da as K,ea as x,fa as B,g as Ce,ga as O,h as z,j as ve,ja as G,ka as Ie,la as H,ma as P,n as I,ra as L,t as pe,ta as xe,ua as E,wa as X,xa as Y}from"./chunk-LGLNOSSO.js";import{$ as ce,$b as k,Bb as n,Cb as t,Db as c,Hb as fe,Lb as N,Mb as D,Oa as s,Q as R,Ta as _,Xb as l,Yb as d,Zb as ge,a as v,aa as he,ab as y,ac as q,b as S,bb as $,bc as J,dc as T,fc as Q,gb as b,nc as j,oc as _e,pc as me,rb as p,ub as be,w as ue}from"./chunk-OPWL5SPH.js";var Ve=()=>({label:"Igualitaria",value:"EQUAL"}),je=()=>({label:"Seg\xFAn Ingresos",value:"INCOME_BASED"}),Ae=(r,o)=>[r,o];function Re(r,o){r&1&&(n(0,"tr")(1,"th"),l(2,"Descripci\xF3n"),t(),n(3,"th"),l(4,"Cuenta"),t(),n(5,"th"),l(6,"Estrategia"),t(),n(7,"th"),l(8,"Fecha L\xEDmite"),t()())}function $e(r,o){r&1&&(n(0,"tr")(1,"th"),l(2,"Miembro"),t(),n(3,"th"),l(4,"Rol"),t(),n(5,"th"),l(6,"Monto (S/)"),t(),n(7,"th"),l(8,"Estado"),t()())}function ke(r,o){if(r&1&&(n(0,"tr")(1,"td"),l(2),t(),n(3,"td"),l(4),t(),n(5,"td"),l(6),j(7,"number"),t(),n(8,"td"),l(9),t()()),r&2){let e=o.$implicit;s(2),d(e.user==null?null:e.user.name),s(2),d((e.user==null?null:e.user.role)==="REPRESENTANTE"?"Representante":"Miembro"),s(2),d(me(7,4,e.monto,"1.2-2")),s(3),d(e.status)}}function qe(r,o){r&1&&(n(0,"tr")(1,"td",23),l(2,"Sin registros de pagos"),t()())}function Je(r,o){if(r&1&&(n(0,"tr")(1,"td"),l(2),t(),n(3,"td"),l(4),t(),n(5,"td"),l(6),t(),n(7,"td"),l(8),j(9,"date"),t()(),n(10,"tr")(11,"td",21)(12,"p-table",22),b(13,$e,9,0,"ng-template",4)(14,ke,10,7,"ng-template",5)(15,qe,3,0,"ng-template",6),t()()()),r&2){let e=o.$implicit,i=D();s(2),d(e.descripcion),s(2),d(i.getBillDescription(e.bill_id)),s(2),d(e.strategy==="EQUAL"?"Igualitaria":"Seg\xFAn Ingresos"),s(2),d(me(9,7,e.fecha_limite,"dd/MM/yyyy")),s(4),p("value",e.details)("responsiveLayout","scroll")("paginator",!1)}}function Qe(r,o){r&1&&(n(0,"tr")(1,"td",23),l(2,"No hay contribuciones registradas."),t()())}function We(r,o){r&1&&(n(0,"small",24),l(1," La descripci\xF3n es obligatoria. "),t())}function ze(r,o){r&1&&(n(0,"small",24),l(1," Seleccione una cuenta. "),t())}function Ke(r,o){r&1&&(n(0,"small",24),l(1," La fecha l\xEDmite es obligatoria. "),t())}function Xe(r,o){r&1&&(n(0,"small",24),l(1," Seleccione una estrategia. "),t())}function Ye(r,o){if(r&1&&c(0,"p-button",25),r&2){let e=D();p("disabled",e.contributionForm.invalid)}}var ee=class r{constructor(o,e){this.http=o;this.fb=e}householdId=0;contributions=[];bills=[];members=[];loading=!0;showForm=!1;contributionForm;ngOnInit(){let o=JSON.parse(localStorage.getItem("currentUser"));this.contributionForm=this.fb.group({bill_id:[null,x.required],descripcion:["",x.required],fecha_limite:["",x.required],strategy:["EQUAL",x.required]}),this.http.get(`http://localhost:3000/households?representante_id=${o.id}`).subscribe(e=>{let i=e[0];i&&(this.householdId=i.id,ue({hms:this.http.get(`http://localhost:3000/household_members?household_id=${this.householdId}`),users:this.http.get("http://localhost:3000/users"),bills:this.http.get(`http://localhost:3000/bills?household_id=${this.householdId}`),contributions:this.http.get(`http://localhost:3000/contributions?household_id=${this.householdId}`),memberContributions:this.http.get("http://localhost:3000/member_contributions")}).subscribe(({hms:m,users:a,bills:u,contributions:h,memberContributions:de})=>{this.bills=u;let f=a.find(g=>g.id==o.id);this.members=[...m.map(g=>S(v({},g),{user:a.find(F=>F.id==g.user_id)})),{user_id:f.id,household_id:this.householdId,user:f}],this.contributions=h.map(g=>{let F=de.filter(C=>C.contribution_id==g.id).map(C=>S(v({},C),{user:a.find(He=>He.id==C.member_id)}));if(!F.some(C=>C.user?.id==f.id)){let C=this.calculateMontoFaltante(g,F,f,a);F.push({contribution_id:g.id,member_id:f.id,monto:C,status:"PENDIENTE",pagado_en:null,user:f})}return S(v({},g),{details:F})}),this.loading=!1}))})}openForm(){this.showForm=!0,this.contributionForm.reset({bill_id:null,descripcion:"",fecha_limite:"",strategy:"EQUAL"})}submit(){let o=S(v({},this.contributionForm.value),{household_id:this.householdId}),e=+o.bill_id,i=this.bills.find(a=>+a.id===e);if(!i){alert("Error: no se encontr\xF3 la cuenta seleccionada.");return}let m=i.monto;this.http.post("http://localhost:3000/contributions",o).subscribe(a=>{this.calculateDivision(m,o.strategy,a.id).forEach(h=>{this.http.post("http://localhost:3000/member_contributions",h).subscribe()}),this.contributions.push(a),this.showForm=!1})}calculateDivision(o,e,i){if(e==="EQUAL"){let m=+(o/this.members.length).toFixed(2);return this.members.map(a=>({contribution_id:i,member_id:a.user_id,monto:m,status:"PENDIENTE",pagado_en:null}))}else{let m=this.members.reduce((a,u)=>a+u.user.income,0);return this.members.map(a=>{let u=a.user.income/m,h=+(o*u).toFixed(2);return{contribution_id:i,member_id:a.user_id,monto:h,status:"PENDIENTE",pagado_en:null}})}}calculateMontoFaltante(o,e,i,m){let a=this.bills.find(f=>f.id==o.bill_id);if(!a)return 0;let u=a.monto,h=o.strategy,de=e.reduce((f,g)=>f+g.monto,0);if(h==="EQUAL"){let f=e.length+1;return+(u/f).toFixed(2)}else{let g=this.members.map(A=>A.user.income).reduce((A,C)=>A+C,0),F=i.income/g;return+(u*F).toFixed(2)}}getBillDescription(o){let e=this.bills.find(i=>+i.id==+o);return e?e.descripcion:"Cuenta no encontrada"}static \u0275fac=function(e){return new(e||r)(_(I),_(L))};static \u0275cmp=y({type:r,selectors:[["app-contributions"]],standalone:!1,decls:31,vars:16,consts:[[1,"p-4","max-w-screen-lg","mx-auto"],["header","Contribuciones del hogar",1,"mt-4"],["label","Nueva contribuci\xF3n","icon","pi pi-plus",1,"mb-3",3,"click"],["responsiveLayout","scroll",3,"value","loading"],["pTemplate","header"],["pTemplate","body"],["pTemplate","emptymessage"],["header","Nueva contribuci\xF3n",2,"width","400px",3,"visibleChange","visible","modal"],[3,"ngSubmit","formGroup"],[1,"p-fluid"],[1,"field"],["for","descripcion"],["id","descripcion","type","text","pInputText","","formControlName","descripcion"],["class","p-error",4,"ngIf"],["for","bill_id"],["inputId","bill_id","optionLabel","descripcion","optionValue","id","formControlName","bill_id","placeholder","Seleccione una cuenta",3,"options"],["for","fecha_limite"],["id","fecha_limite","type","date","pInputText","","formControlName","fecha_limite"],["for","strategy"],["inputId","strategy","formControlName","strategy","placeholder","Seleccione una estrategia",3,"options"],["pTemplate","footer"],["colspan","4"],["styleClass","p-datatable-sm",3,"value","responsiveLayout","paginator"],["colspan","4",1,"text-center"],[1,"p-error"],["type","submit","label","Guardar",3,"disabled"]],template:function(e,i){if(e&1&&(n(0,"div",0)(1,"p-card",1)(2,"p-button",2),N("click",function(){return i.openForm()}),t(),n(3,"p-table",3),b(4,Re,9,0,"ng-template",4)(5,Je,16,10,"ng-template",5)(6,Qe,3,0,"ng-template",6),t()(),n(7,"p-dialog",7),J("visibleChange",function(a){return q(i.showForm,a)||(i.showForm=a),a}),n(8,"form",8),N("ngSubmit",function(){return i.submit()}),n(9,"div",9)(10,"div",10)(11,"label",11),l(12,"Descripci\xF3n"),t(),c(13,"input",12),b(14,We,2,0,"small",13),t(),n(15,"div",10)(16,"label",14),l(17,"Cuenta"),t(),c(18,"p-dropdown",15),b(19,ze,2,0,"small",13),t(),n(20,"div",10)(21,"label",16),l(22,"Fecha L\xEDmite"),t(),c(23,"input",17),b(24,Ke,2,0,"small",13),t(),n(25,"div",10)(26,"label",18),l(27,"Estrategia"),t(),c(28,"p-dropdown",19),b(29,Xe,2,0,"small",13),t()(),b(30,Ye,1,1,"ng-template",20),t()()()),e&2){let m,a,u,h;s(3),p("value",i.contributions)("loading",i.loading),s(4),k("visible",i.showForm),p("modal",!0),s(),p("formGroup",i.contributionForm),s(6),p("ngIf",((m=i.contributionForm.get("descripcion"))==null?null:m.invalid)&&((m=i.contributionForm.get("descripcion"))==null?null:m.touched)),s(4),p("options",i.bills),s(),p("ngIf",((a=i.contributionForm.get("bill_id"))==null?null:a.invalid)&&((a=i.contributionForm.get("bill_id"))==null?null:a.touched)),s(5),p("ngIf",((u=i.contributionForm.get("fecha_limite"))==null?null:u.invalid)&&((u=i.contributionForm.get("fecha_limite"))==null?null:u.touched)),s(4),p("options",Q(13,Ae,T(11,Ve),T(12,je))),s(),p("ngIf",((h=i.contributionForm.get("strategy"))==null?null:h.invalid)&&((h=i.contributionForm.get("strategy"))==null?null:h.touched))}},dependencies:[W,M,w,E,X,G,K,B,O,Y,U,H,P,Z,z,Ce],encapsulation:2})};var Ze=()=>({label:"Espa\xF1ol",value:"es"}),et=()=>({label:"Ingl\xE9s",value:"en"}),tt=(r,o)=>[r,o];function it(r,o){if(r&1){let e=fe();n(0,"form",2),N("ngSubmit",function(){ce(e);let m=D();return he(m.save())}),n(1,"div",3)(2,"div",4)(3,"label",5),l(4,"Idioma"),t(),c(5,"p-dropdown",6),t(),n(6,"div",4)(7,"label",7),l(8,"Modo oscuro"),t(),c(9,"p-inputSwitch",8),t(),n(10,"div",4)(11,"label",9),l(12,"Notificaciones"),t(),c(13,"p-inputSwitch",10),t()(),n(14,"div",11),c(15,"p-button",12),t()()}if(r&2){let e=D();p("formGroup",e.form),s(5),p("options",Q(4,tt,T(2,Ze),T(3,et)))}}var oe=class r{constructor(o,e){this.http=o;this.fb=e}form;userId;settingId;ngOnInit(){let o=JSON.parse(localStorage.getItem("currentUser"));this.userId=o.id,this.http.get(`http://localhost:3000/settings?user_id=${this.userId}`).subscribe(e=>{let i=e[0];this.settingId=i?.id,this.form=this.fb.group({language:[i?.language||"es"],dark_mode:[i?.dark_mode||!1],notifications_enabled:[i?.notifications_enabled||!1]})})}save(){let o=this.form.value;this.settingId?this.http.put(`http://localhost:3000/settings/${this.settingId}`,S(v({},o),{user_id:this.userId})).subscribe(()=>alert("Configuraci\xF3n actualizada")):this.http.post("http://localhost:3000/settings",S(v({},o),{user_id:this.userId})).subscribe(()=>alert("Configuraci\xF3n guardada"))}static \u0275fac=function(e){return new(e||r)(_(I),_(L))};static \u0275cmp=y({type:r,selectors:[["app-settings"]],standalone:!1,decls:2,vars:1,consts:[["header","Ajustes de usuario",1,"mt-4"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],[1,"p-fluid"],[1,"field"],["for","language"],["formControlName","language","placeholder","Seleccione un idioma",3,"options"],["for","dark_mode"],["formControlName","dark_mode"],["for","notifications_enabled"],["formControlName","notifications_enabled"],[1,"mt-3"],["type","submit","label","Guardar cambios","icon","pi pi-save"]],template:function(e,i){e&1&&(n(0,"p-card",0),b(1,it,16,7,"form",1),t()),e&2&&(s(),p("ngIf",i.form))},dependencies:[W,w,E,G,B,O,Ee,H,P,Z],styles:["[_nghost-%COMP%]     .p-card{max-width:500px;margin:0 auto}.p-field[_ngcontent-%COMP%]{display:flex;flex-direction:column}"]})};function nt(r,o){r&1&&(n(0,"tr")(1,"th"),l(2,"Nombre"),t(),n(3,"th"),l(4,"Email"),t(),n(5,"th"),l(6,"Ingreso mensual"),t()())}function ot(r,o){if(r&1&&(n(0,"tr")(1,"td"),l(2),t(),n(3,"td"),l(4),t(),n(5,"td"),l(6),j(7,"number"),t()()),r&2){let e=o.$implicit;s(2),d(e.name),s(2),d(e.email),s(2),ge("S/. ",_e(7,3,e.income),"")}}var re=class r{constructor(o){this.http=o}members=[];loading=!0;ngOnInit(){let o=JSON.parse(localStorage.getItem("currentUser"));this.http.get(`http://localhost:3000/households?representante_id=${Number(o.id)}`).subscribe(e=>{let i=e[0];console.log("Household:",i),i&&this.http.get(`http://localhost:3000/household_members?household_id=${i.id}`).subscribe(m=>{let a=m.map(u=>Number(u.user_id));console.log("IDs de miembros:",a),this.http.get("http://localhost:3000/users").subscribe(u=>{this.members=u.filter(h=>a.includes(Number(h.id))),console.log("Miembros encontrados:",this.members),this.loading=!1})})})}static \u0275fac=function(e){return new(e||r)(_(I))};static \u0275cmp=y({type:r,selectors:[["app-members"]],standalone:!1,decls:5,vars:2,consts:[[1,"p-4","max-w-screen-lg","mx-auto"],["header","Miembros del hogar",1,"mt-4"],["responsiveLayout","scroll",3,"value","loading"],["pTemplate","header"],["pTemplate","body"]],template:function(e,i){e&1&&(n(0,"div",0)(1,"p-card",1)(2,"p-table",2),b(3,nt,7,0,"ng-template",3)(4,ot,8,5,"ng-template",4),t()()()),e&2&&(s(2),p("value",i.members)("loading",i.loading))},dependencies:[M,E,U,z],encapsulation:2})};var rt=()=>({width:"400px"});function lt(r,o){r&1&&(n(0,"tr")(1,"th"),l(2,"Descripci\xF3n"),t(),n(3,"th"),l(4,"Monto (S/)"),t(),n(5,"th"),l(6,"Fecha"),t()())}function at(r,o){if(r&1&&(n(0,"tr")(1,"td"),l(2),t(),n(3,"td"),l(4),t(),n(5,"td"),l(6),t()()),r&2){let e=o.$implicit;s(2),d(e.descripcion),s(2),d(e.monto),s(2),d(e.fecha)}}var le=class r{constructor(o,e){this.http=o;this.fb=e}bills=[];householdId=0;loading=!0;formVisible=!1;billForm;ngOnInit(){let o=JSON.parse(localStorage.getItem("currentUser"));this.billForm=this.fb.group({descripcion:["",x.required],monto:[null,[x.required,x.min(0)]],fecha:[new Date().toISOString().substring(0,10),x.required]}),this.http.get(`http://localhost:3000/households?representante_id=${o.id}`).subscribe(e=>{let i=e[0];i&&(this.householdId=i.id,this.http.get(`http://localhost:3000/bills?household_id=${i.id}`).subscribe(m=>{this.bills=m,this.loading=!1}))})}showForm(){this.formVisible=!0,this.billForm.reset({descripcion:"",monto:null,fecha:new Date().toISOString().substring(0,10)})}submit(){let o=JSON.parse(localStorage.getItem("currentUser")),e=S(v({},this.billForm.value),{household_id:this.householdId,created_by:o.id});this.http.post("http://localhost:3000/bills",e).subscribe(i=>{this.bills.push(i),this.formVisible=!1})}static \u0275fac=function(e){return new(e||r)(_(I),_(L))};static \u0275cmp=y({type:r,selectors:[["app-bills"]],standalone:!1,decls:23,vars:9,consts:[[1,"p-4","max-w-screen-lg","mx-auto"],["header","Cuentas del hogar",1,"mt-4"],["label","Registrar nueva cuenta","icon","pi pi-plus",1,"mb-3",3,"click"],["responsiveLayout","scroll",3,"value","loading"],["pTemplate","header"],["pTemplate","body"],["header","Nueva cuenta",3,"visibleChange","visible","modal"],[3,"ngSubmit","formGroup"],[1,"p-fluid"],[1,"field"],["for","descripcion"],["id","descripcion","type","text","pInputText","","formControlName","descripcion"],["for","monto"],["id","monto","type","number","pInputText","","formControlName","monto"],["for","fecha"],["id","fecha","type","date","pInputText","","formControlName","fecha"],["pButton","","type","submit","label","Guardar",3,"disabled"]],template:function(e,i){e&1&&(n(0,"div",0)(1,"p-card",1)(2,"p-button",2),N("click",function(){return i.showForm()}),t(),n(3,"p-table",3),b(4,lt,7,0,"ng-template",4)(5,at,7,3,"ng-template",5),t()(),n(6,"p-dialog",6),J("visibleChange",function(a){return q(i.formVisible,a)||(i.formVisible=a),a}),n(7,"form",7),N("ngSubmit",function(){return i.submit()}),n(8,"div",8)(9,"div",9)(10,"label",10),l(11,"Descripci\xF3n"),t(),c(12,"input",11),t(),n(13,"div",9)(14,"label",12),l(15,"Monto"),t(),c(16,"input",13),t(),n(17,"div",9)(18,"label",14),l(19,"Fecha"),t(),c(20,"input",15),t()(),n(21,"p-footer"),c(22,"p-button",16),t()()()()),e&2&&(s(3),p("value",i.bills)("loading",i.loading),s(3),be(T(8,rt)),k("visible",i.formVisible),p("modal",!0),s(),p("formGroup",i.billForm),s(15),p("disabled",i.billForm.invalid))},dependencies:[Se,M,ye,w,E,X,G,K,Ie,B,O,Y,U,H,P],encapsulation:2})};var ae=class r{constructor(o){this.http=o}household;members=[];bills=[];contributions=[];ngOnInit(){let e=JSON.parse(localStorage.getItem("currentUser"))?.id;this.http.get(`http://localhost:3000/households?representante_id=${e}`).subscribe(i=>{if(this.household=i[0],this.household){let m=this.household.id;this.http.get(`http://localhost:3000/household_members?household_id=${m}`).subscribe(a=>this.members=a),this.http.get(`http://localhost:3000/bills?household_id=${m}`).subscribe(a=>this.bills=a),this.http.get(`http://localhost:3000/contributions?household_id=${m}`).subscribe(a=>this.contributions=a)}})}static \u0275fac=function(e){return new(e||r)(_(I))};static \u0275cmp=y({type:r,selectors:[["app-home"]],standalone:!1,decls:19,vars:5,consts:[[1,"p-4","max-w-screen-lg","mx-auto"],["header","Resumen del hogar",1,"mb-4"],[1,"text-xl","mb-2"],[1,"text-muted","mb-3"],[1,"grid"],[1,"col-12","md:col-4"],["header","Miembros"],[1,"text-center","text-2xl"],["header","Cuentas"],["header","Contribuciones"]],template:function(e,i){e&1&&(n(0,"div",0)(1,"p-card",1)(2,"div",2),l(3),t(),n(4,"div",3),l(5),t(),n(6,"div",4)(7,"div",5)(8,"p-panel",6)(9,"div",7),l(10),t()()(),n(11,"div",5)(12,"p-panel",8)(13,"div",7),l(14),t()()(),n(15,"div",5)(16,"p-panel",9)(17,"div",7),l(18),t()()()()()()),e&2&&(s(3),d(i.household==null?null:i.household.name),s(2),d(i.household==null?null:i.household.description),s(5),d(i.members.length),s(4),d(i.bills.length),s(4),d(i.contributions.length))},dependencies:[E,Fe],encapsulation:2})};var st=[{path:"",redirectTo:"home",pathMatch:"full"},{path:"home",component:ae},{path:"members",component:re},{path:"bills",component:le},{path:"contributions",component:ee},{path:"settings",component:oe}],se=class r{static \u0275fac=function(e){return new(e||r)};static \u0275mod=$({type:r});static \u0275inj=R({imports:[pe.forChild(st),pe]})};var Ge=class r{static \u0275fac=function(e){return new(e||r)};static \u0275mod=$({type:r});static \u0275inj=R({imports:[ve,se,Ne,xe,Te]})};export{Ge as RepresentativeModule};
